import SwiftUI

struct ResultView: View {
    let result: AssetRankingResult
    let onBack: () -> Void
    
    @State private var showingDetails = false
    @State private var animationOffset: CGFloat = 50
    @State private var animationOpacity: Double = 0
    
    var body: some View {
        ZStack(alignment: .top) {
            // Î∞∞Í≤Ω Í∑∏ÎùºÎç∞Ïù¥ÏÖò
            AppTheme.backgroundGradient
                .ignoresSafeArea()
            
            ScrollView {
                VStack(spacing: 24) {
                    // Ìó§Îçî
                    VStack(spacing: 16) {
                        HStack {
                            BackButton(action: onBack)
                            Spacer()
                        }
                        .padding(.horizontal, 20)
                        .padding(.top, 8)
                        
                        // Í≤∞Í≥º ÌÉÄÏù¥ÌãÄ
                        VStack(spacing: 8) {
                            Text("ÏûêÏÇ∞ ÏàúÏúÑ Í≤∞Í≥º")
                                .font(AppTheme.getFont(size: 28, weight: .bold))
                                .foregroundColor(.primary)
                            
                            Text("ÎãπÏã†Ïùò ÏàúÏûêÏÇ∞ ÏàúÏúÑÎäî")
                                .font(AppTheme.getFont(size: 16, weight: .light))
                                .foregroundColor(.secondary)
                        }
                    }
                    
                    // Î©îÏù∏ Í≤∞Í≥º Ïπ¥Îìú
                    CardView(cornerRadius: 20, shadowRadius: 12) {
                        VStack(spacing: 24) {
                            // ÏàúÏúÑ Î∞∞ÏßÄ
                            VStack(spacing: 16) {
                                RankBadge(
                                    percentile: result.percentile,
                                    showDescription: true
                                )
                                
                                Text(result.description)
                                    .font(AppTheme.getFont(size: 18, weight: .semibold))
                                    .foregroundColor(.primary)
                                    .multilineTextAlignment(.center)
                            }
                            
                            // ÏûêÏÇ∞ Í∏àÏï°
                            VStack(spacing: 8) {
                                Text("ÏàúÏûêÏÇ∞Ïï°")
                                    .font(AppTheme.getFont(size: 16, weight: .light))
                                    .foregroundColor(.secondary)
                                
                                Text("‚Ç©\(result.netWorth.formattedWithCommas)")
                                    .font(AppTheme.getFont(size: 32, weight: .bold))
                                    .foregroundColor(RankColorHelper.colorForRank(result.percentile))
                            }
                            
                            // ÏàúÏúÑ Ï†ïÎ≥¥
                            VStack(spacing: 12) {
                                HStack {
                                    Text("Ï†ÑÏ≤¥ ÏàúÏúÑ")
                                        .font(AppTheme.getFont(size: 14, weight: .light))
                                        .foregroundColor(.secondary)
                                    Spacer()
                                    Text("\(result.rank.formattedWithCommas)ÏúÑ")
                                        .font(AppTheme.getFont(size: 16, weight: .semibold))
                                        .foregroundColor(.primary)
                                }
                                
                                HStack {
                                    Text("ÏÉÅÏúÑ ÎπÑÏú®")
                                        .font(AppTheme.getFont(size: 14, weight: .light))
                                        .foregroundColor(.secondary)
                                    Spacer()
                                    Text(result.percentile.formattedPercent)
                                        .font(AppTheme.getFont(size: 16, weight: .semibold))
                                        .foregroundColor(.primary)
                                }
                            }
                            .padding(.horizontal, 16)
                            .padding(.vertical, 12)
                            .background(
                                RoundedRectangle(cornerRadius: 12)
                                    .fill(Color(.systemGray6))
                            )
                        }
                    }
                    .padding(.horizontal, 20)
                    .offset(y: animationOffset)
                    .opacity(animationOpacity)
                    
                    // ÏÉÅÏÑ∏ ÌÜµÍ≥Ñ Ïπ¥ÎìúÎì§
                    LazyVGrid(columns: [
                        GridItem(.flexible()),
                        GridItem(.flexible())
                    ], spacing: 16) {
                        ResultCard(
                            title: "ÌèâÍ∑† ÏàúÏûêÏÇ∞",
                            value: "‚Ç©\(result.averageNetWorth.formattedWithCommas)",
                            subtitle: "Ï†ÑÍµ≠ ÌèâÍ∑†",
                            color: .blue
                        )
                        
                        ResultCard(
                            title: "Ï§ëÍ∞ÑÍ∞í ÏàúÏûêÏÇ∞",
                            value: "‚Ç©\(result.medianNetWorth.formattedWithCommas)",
                            subtitle: "Ï†ÑÍµ≠ Ï§ëÍ∞ÑÍ∞í",
                            color: .green
                        )
                    }
                    .padding(.horizontal, 20)
                    .offset(y: animationOffset + 20)
                    .opacity(animationOpacity * 0.8)
                    
                    // ÎπÑÍµê Ï†ïÎ≥¥
                    CardView(cornerRadius: 16, shadowRadius: 8) {
                        VStack(alignment: .leading, spacing: 16) {
                            Text("Î∂ÑÏÑù Í≤∞Í≥º")
                                .font(AppTheme.getFont(size: 18, weight: .semibold))
                                .foregroundColor(.primary)
                            
                            VStack(alignment: .leading, spacing: 12) {
                                Text(result.comparison)
                                    .font(AppTheme.getFont(size: 16, weight: .light))
                                    .foregroundColor(.primary)
                                
                                Divider()
                                
                                VStack(alignment: .leading, spacing: 8) {
                                    Text("‚Ä¢ Ï†ÑÍµ≠ \(result.totalPopulation.formattedWithCommas)Î™Ö Ï§ë \(result.rank.formattedWithCommas)ÏúÑ")
                                        .font(AppTheme.getFont(size: 14, weight: .light))
                                        .foregroundColor(.secondary)
                                    
                                    Text("‚Ä¢ ÏÉÅÏúÑ \(result.percentile.formattedPercent)Ïóê Ìï¥Îãπ")
                                        .font(AppTheme.getFont(size: 14, weight: .light))
                                        .foregroundColor(.secondary)
                                    
                                    Text("‚Ä¢ \(result.category.rawValue) ÏûêÏÇ∞ Í∑∏Î£π")
                                        .font(AppTheme.getFont(size: 14, weight: .light))
                                        .foregroundColor(.secondary)
                                }
                            }
                        }
                    }
                    .padding(.horizontal, 20)
                    .offset(y: animationOffset + 40)
                    .opacity(animationOpacity * 0.6)
                    
                    // Í≥µÏú† Î≤ÑÌäº
                    Button(action: {
                        shareResult()
                    }) {
                        HStack {
                            Image(systemName: "square.and.arrow.up")
                                .font(.title3)
                            Text("Í≤∞Í≥º Í≥µÏú†ÌïòÍ∏∞")
                                .font(AppTheme.getFont(size: 18, weight: .semibold))
                        }
                        .foregroundColor(.white)
                        .frame(maxWidth: .infinity)
                        .frame(height: 56)
                        .background(AppTheme.primaryGradient)
                        .cornerRadius(AppTheme.cornerRadius)
                    }
                    .padding(.horizontal, 20)
                    .offset(y: animationOffset + 60)
                    .opacity(animationOpacity * 0.4)
                    
                    Spacer(minLength: 100)
                }
            }
        }
        .navigationTitle("")
        .navigationBarTitleDisplayMode(.inline)
        .navigationBarHidden(true)
        .onAppear {
            startAnimation()
        }
    }
    
    private func startAnimation() {
        withAnimation(.spring(response: 0.8, dampingFraction: 0.7)) {
            animationOffset = 0
            animationOpacity = 1
        }
    }
    
    private func shareResult() {
        let shareText = """
        üí∞ ÏûêÏÇ∞Îû≠ÌÇπ Í≤∞Í≥º
        
        ÏàúÏûêÏÇ∞Ïï°: ‚Ç©\(result.netWorth.formattedWithCommas)
        Ï†ÑÍµ≠ ÏàúÏúÑ: \(result.rank.formattedWithCommas)ÏúÑ
        ÏÉÅÏúÑ ÎπÑÏú®: \(result.percentile.formattedPercent)
        ÏûêÏÇ∞ Í∑∏Î£π: \(result.category.rawValue)
        
        \(result.description)
        
        #ÏûêÏÇ∞Îû≠ÌÇπ #AssetRank
        """
        
        let activityViewController = UIActivityViewController(
            activityItems: [shareText],
            applicationActivities: nil
        )
        
        if let windowScene = UIApplication.shared.connectedScenes.first as? UIWindowScene,
           let window = windowScene.windows.first {
            window.rootViewController?.present(activityViewController, animated: true)
        }
    }
}

#Preview {
    ResultView(
        result: AssetRankingResult(
            netWorth: 150000000,
            percentile: 15.5,
            rank: 8000000,
            totalPopulation: 52000000,
            averageNetWorth: 65000000,
            medianNetWorth: 45000000,
            category: .top25,
            description: "Ï†ÑÍµ≠ ÏÉÅÏúÑ 25%Ïùò ÏûêÏÇ∞ÏùÑ Î≥¥Ïú†ÌïòÍ≥† ÏûàÏäµÎãàÎã§",
            comparison: "ÌèâÍ∑† ÎåÄÎπÑ 2.3Î∞∞ ÎÜíÏäµÎãàÎã§"
        ),
        onBack: {}
    )
}
